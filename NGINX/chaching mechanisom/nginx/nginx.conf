# loadbalancer-project/nginx/nginx.conf (With Caching Added).

# ==========================================================
# 1. CACHING SETUP (Must be in the 'http' context, which Nginx adds)
# Define a cache path, key zone, and maximum size.
# The 'http' block is provided by the main Nginx config, so this is OK here.
# NOTE: The *path* for the cache (e.g., /var/cache/nginx/my_cache_zone) needs
# a *volume* mount in docker-compose.yml to persist the cache!
proxy_cache_path /var/cache/nginx/my_cache_zone levels=1:2 keys_zone=my_cache_zone:10m max_size=1g inactive=60m use_temp_path=off;
# 'levels=1:2' creates a two-level directory hierarchy for better performance
# 'keys_zone=my_cache_zone:10m' allocates 10MB of shared memory for the cache keys
# 'max_size=1g' sets the maximum size of the cache to 1GB
# 'inactive=60m' removes files that haven't been accessed for 60 minutes
# ==========================================================

# Define the group of backend servers.
upstream backend_servers {
    server app:8080;
    server app:8080;
    server app:8080;
}

# The main server block that listens for incoming connections
server {
    listen 80;

    location / {
        # ----------------------------------------------
        # 2. CACHING DIRECTIVES (Inside the location block)
        # Enable caching using the defined key zone
        proxy_cache my_cache_zone;

        # The key used to cache an item (often includes the request URI)
        proxy_cache_key "$scheme$request_method$host$request_uri";

        # Cache items for a specified time (e.g., 5 minutes for successful responses)
        # Use 'off' to disable caching for specific status codes if needed
        proxy_cache_valid 200 302 5m;
        proxy_cache_valid 404 1m;

        # Header to see if the response was a HIT, MISS, or BYPASS
        add_header X-Cache-Status $upstream_cache_status;

        # Don't cache if the request contains an Authorization header (optional, but common)
        proxy_cache_bypass $http_authorization;
        # ----------------------------------------------

        # Proxy the request to the backend_servers group
        proxy_pass http://backend_servers;

        # Set headers for better logging/request tracing
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}